<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Flip 7 Pro</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <style>
        :root {
            /* MODERN PALETTE */
            --bg-color: #f0f2f5;
            --header-gradient: linear-gradient(135deg, #ff9966, #ff5e62);
            --card-bg: #ffffff;
            --footer-bg: #2d3436; 
            --text-color: #2d3436;
            
            /* Game Card Colors */
            --card-num-bg: #0984e3;
            --card-bonus-bg: #e17055;
            --card-mult-bg: #a29bfe;
            
            --grid-cols: 50px 1fr 1fr 1fr 1fr;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0; padding: 0; user-select: none; overflow: hidden; 
            height: 100vh; height: 100dvh; display: flex; flex-direction: column; color: var(--text-color);
        }

        /* HEADER */
        .app-header { flex-shrink: 0; width: 100%; background: var(--header-gradient); z-index: 50; padding-top: env(safe-area-inset-top); box-shadow: 0 4px 15px rgba(255, 94, 98, 0.4); }
        .header-content { max-width: 1000px; margin: 0 auto; display: grid; grid-template-columns: var(--grid-cols); text-align: center; align-items: center; padding: 15px 0; }
        .header-name { font-size: 2.5rem; font-weight: 800; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        /* CONTENT */
        .scroll-container { flex: 1; width: 100%; max-width: 1000px; margin: 0 auto; overflow-y: auto; -webkit-overflow-scrolling: touch; padding-bottom: 180px; padding-top: 15px; }
        .round-row { display: grid; grid-template-columns: var(--grid-cols); align-items: center; text-align: center; background: var(--card-bg); margin: 0 15px 12px 15px; padding: 10px 0; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .round-num { font-size: 1.2rem; color: #b2bec3; font-weight: 800; }
        .score-cell { padding: 0 5px; }
        .score-display { width: 90%; border: 2px solid #dfe6e9; border-radius: 12px; font-size: 2.8rem; font-weight: 800; background: #fafafa; display: flex; align-items: center; justify-content: center; height: 3.6rem; color: var(--text-color); margin: 0 auto; }

        /* CONTROLS */
        .controls-container { display: flex; gap: 15px; justify-content: center; padding: 30px; }
        .main-btn { border: none; padding: 18px 30px; border-radius: 50px; font-size: 1.3rem; font-weight: 800; color: white; box-shadow: 0 6px 15px rgba(0,0,0,0.15); cursor: pointer; transition: transform 0.1s; }
        .main-btn:active { transform: scale(0.95); }
        .btn-add { background-color: #2ecc71; flex-grow: 2; }
        .btn-reset { background-color: #ff7675; flex-grow: 1; }

        /* FOOTER */
        footer { position: fixed; bottom: 0; left: 0; width: 100%; display: flex; justify-content: center; box-shadow: 0 -8px 30px rgba(0,0,0,0.2); z-index: 100; border-radius: 20px 20px 0 0; cursor: pointer; }
        footer::before { content: ""; position: absolute; top: 0; left: 0; right: 0; bottom: -100px; background: var(--footer-bg); border-radius: 20px 20px 0 0; z-index: -1; }
        .footer-content { width: 100%; max-width: 1000px; display: grid; grid-template-columns: var(--grid-cols); padding: 15px 0 25px 0; align-items: center; padding-bottom: calc(25px + env(safe-area-inset-bottom)); position: relative; }
        .total-box { display: flex; flex-direction: column; align-items: center; justify-content: center; transition: all 0.3s; border-radius: 15px; margin: 0 5px; padding: 5px 0; }
        .total-val { font-size: 5rem; font-weight: 900; line-height: 0.9; color: white; }
        .is-leading { background-color: #fdcb6e; box-shadow: 0 0 20px rgba(253, 203, 110, 0.4); }
        .is-leading .total-val { color: var(--text-color); }
        .crown { font-size: 1.5rem; height: 1.5rem; visibility: hidden; margin-bottom: 0px; }
        .is-leading .crown { visibility: visible; }
        .sigma-icon { display:flex; align-items:center; justify-content:center; font-size:2rem; color:#636e72; height: 100%; }

        /* OVERLAYS COMMON */
        #scoringOverlay, #victoryOverlay, #manualModal, #statsOverlay, #playerManagerOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; }
        
        /* SCORING OVERLAY */
        #scoringOverlay { background: white; flex-direction: column; transition: opacity 0.3s; }
        .overlay-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 25px; background: var(--bg-color); border-bottom: 1px solid #dfe6e9; flex-shrink: 0; height: auto; min-height: 90px; padding-top: max(25px, env(safe-area-inset-top)); padding-bottom: 15px; }
        .header-left { display: flex; flex-direction: column; justify-content: center; }
        .calc-title { font-size: 1rem; font-weight: 700; color: #b2bec3; letter-spacing: 1px; }
        .player-name-display { font-size: 2.2rem; font-weight: 900; color: var(--text-color); }
        .tally-box { display: flex; flex-direction: row; align-items: center; gap: 25px; flex-wrap: nowrap; }
        .tally-info { display: flex; flex-direction: column; align-items: flex-end; justify-content: center; }
        .tally-label { font-size: 1.1rem; font-weight: bold; color: #636e72; white-space: nowrap; line-height: 1.4; }
        .tally-total { font-size: 5rem; font-weight: 900; line-height: 1; color: var(--text-color); min-width: 100px; text-align: right; }
        .overlay-body { flex: 1; padding: 15px 20px; display: flex; flex-direction: column; gap: 15px; overflow: hidden; }
        .grid-modifiers { display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px; height: 16%; min-height: 90px; }
        .grid-numbers { display: grid; grid-template-columns: repeat(5, 1fr); grid-template-rows: repeat(3, 1fr); gap: 12px; flex-grow: 1; }
        .card { width: 100%; height: 100%; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-weight: 900; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: transform 0.1s; opacity: 0.4; filter: grayscale(40%); }
        .card.selected { outline: 8px solid #2ecc71; outline-offset: -2px; transform: scale(1.02); opacity: 1; filter: grayscale(0%); z-index: 10; }
        .card.modifier { background: var(--card-bonus-bg); font-size: 2.5rem; }
        .card.multiplier { background: var(--card-mult-bg); font-size: 2.5rem; }
        .card.num { background: var(--card-num-bg); font-size: 4.5rem; }
        .action-bar { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; padding: 15px 20px 30px 20px; background: #dfe6e9; padding-bottom: max(30px, env(safe-area-inset-bottom)); }
        .action-btn { padding: 22px 0; border: none; border-radius: 16px; font-size: 1.4rem; font-weight: 800; color: white; }
        .btn-bust { background: #d63031; } .btn-manual { background: #636e72; } .btn-cancel { background: #b2bec3; color: #2d3436; } .btn-ok { background: #00b894; }

        /* VICTORY OVERLAY */
        #victoryOverlay { background: rgba(45, 52, 54, 0.95); backdrop-filter: blur(10px); display: none; flex-direction: column; align-items: center; justify-content: center; color: white; text-align: center; }
        .victory-title { font-size: 4rem; font-weight: 900; margin-bottom: 10px; color: #fab1a0; text-shadow: 0 0 20px rgba(250, 177, 160, 0.5); }
        .winner-name { font-size: 7rem; font-weight: 900; margin-bottom: 20px; color: #fdcb6e; text-shadow: 0 4px 10px rgba(253, 203, 110, 0.5); line-height: 1; }
        .hulu-container { margin: 10px 0; animation: hulu-dance 2s infinite ease-in-out; }
        @keyframes hulu-dance { 0%, 100% { transform: translateY(0) rotate(0deg) scale(1); } 25% { transform: translateY(-10px) rotate(-10deg) scale(1.1); } 50% { transform: translateY(0) rotate(0deg) scale(1); } 75% { transform: translateY(-10px) rotate(10deg) scale(1.1); } }
        .final-scores { display: flex; gap: 20px; margin: 30px 0; }
        .final-score-box { background: rgba(255,255,255,0.1); padding: 20px 35px; border-radius: 20px; text-align: center; }
        .fs-label { font-size: 2rem; color: #fff; font-weight: 800; margin-bottom: 5px; }
        .fs-val { font-size: 4.5rem; font-weight: 900; color: #fab1a0; line-height: 1; }
        .victory-actions { display: flex; gap: 20px; margin-top: 20px; }
        .v-btn { padding: 25px 50px; border: none; border-radius: 50px; font-size: 1.8rem; font-weight: 900; cursor: pointer; }
        .v-btn-new { background: #00b894; color: white; box-shadow: 0 10px 20px rgba(0, 184, 148, 0.4); }
        .v-btn-close { background: rgba(255,255,255,0.2); color: white; }

        /* STATS OVERLAY */
        #statsOverlay {
            background: rgba(45, 52, 54, 0.98); backdrop-filter: blur(15px);
            flex-direction: column; align-items: center; justify-content: center;
            color: white; z-index: 2000;
        }
        .stats-container { width: 90%; max-width: 850px; }
        .stats-title { font-size: 2.5rem; font-weight: 900; color: #fab1a0; text-align: center; margin-bottom: 40px; letter-spacing: 2px; }
        .stat-row { display: grid; grid-template-columns: 80px 1fr 240px; gap: 20px; background: rgba(255,255,255,0.1); margin-bottom: 25px; padding: 20px 30px; border-radius: 20px; align-items: center; }
        .stat-name { font-size: 2.2rem; font-weight: 800; color: white; text-align: center; }
        .progress-track { height: 75px; width: 100%; background: rgba(255,255,255,0.2); border-radius: 15px; overflow: hidden; position: relative; display: flex; align-items: center; justify-content: space-between; padding: 0 25px; }
        .progress-bar { position: absolute; left: 0; top: 0; bottom: 0; background: linear-gradient(90deg, #0984e3, #00b894); border-radius: 15px; transition: width 0.5s ease-out; z-index: 1; }
        .pb-text-left { position: relative; z-index: 5; font-weight: 900; font-size: 3rem; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.4); }
        .pb-text-right { position: relative; z-index: 5; font-weight: 700; font-size: 1.8rem; color: rgba(255,255,255,0.95); text-shadow: 0 2px 4px rgba(0,0,0,0.4); }
        .stat-metric { display: flex; flex-direction: column; align-items: center; }
        .stat-row .stat-metric:last-child { align-items: flex-end; } 
        .stat-metric-label { font-size: 0.9rem; color: #b2bec3; text-transform: uppercase; font-weight: 700; margin-bottom: 5px; }
        .stat-metric-val { font-size: 2.5rem; font-weight: 900; color: white; }
        .val-good { color: #00b894; } .val-bad { color: #ff7675; } .val-gold { color: #fdcb6e; }

        /* MANUAL MODAL */
        #manualModal { background: #2d3436; top: 50%; left: 50%; width: 500px; max-width: 95vw; height: auto; transform: translate(-50%, -50%); padding: 40px; border-radius: 40px; box-shadow: 0 20px 50px rgba(0,0,0,0.6); display: none; flex-direction: column; }
        #manualDisplay { color: white; font-size: 8rem; text-align: center; margin-bottom: 30px; font-weight: 900; line-height: 1; }
        .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px; max-width: 400px; width: 100%; margin-left: auto; margin-right: auto; }
        .num-btn { width: 100%; aspect-ratio: 1; font-size: 4rem; border-radius: 50%; border: none; background: #636e72; color: white; font-weight: 700; box-shadow: 0 4px 0 rgba(0,0,0,0.2); }
        .num-btn:active { transform: translateY(2px); box-shadow: none; }
        .btn-clear { background: #d63031 !important; }
        .manual-actions-row { display: flex; flex-direction: column; gap: 15px; max-width: 400px; width: 100%; margin: 0 auto; }
        .btn-manual-ok { width: 100%; padding: 25px; background: #00b894; color: white; border: none; border-radius: 20px; font-size: 2rem; font-weight: 900; box-shadow: 0 6px 0 #008b70; margin-bottom: 10px; }
        .btn-manual-ok:active { transform: translateY(4px); box-shadow: 0 2px 0 #008b70; }
        .manual-cancel-btn { width: 100%; padding: 18px; background: transparent; color: #b2bec3; border: 2px solid #636e72; border-radius: 15px; font-size: 1.2rem; font-weight: bold; }

        /* PLAYER MANAGER OVERLAY & CUSTOM KEYBOARD */
        #playerManagerOverlay {
            background: rgba(45, 52, 54, 0.98); backdrop-filter: blur(15px);
            display: none; flex-direction: column; align-items: center; justify-content: flex-start;
            padding-top: 60px; z-index: 3000;
        }
        .pm-title { font-size: 2rem; color: #fab1a0; font-weight: 900; margin-bottom: 20px; letter-spacing: 1px; }
        
        /* Scrollable Player List */
        .pm-list-container {
            width: 90%; max-width: 500px;
            max-height: 30vh; overflow-y: auto;
            margin-bottom: 20px;
        }
        .pm-player-row {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.1); padding: 15px 20px;
            margin-bottom: 10px; border-radius: 15px;
            border: 2px solid transparent; transition: all 0.2s;
        }
        .pm-player-row.active-edit { border-color: #0984e3; background: rgba(9, 132, 227, 0.2); }
        .pm-name-display { font-size: 1.8rem; color: white; font-weight: bold; }
        .pm-row-actions { display: flex; gap: 15px; }
        .pm-icon-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; padding: 5px; }
        
        .pm-add-btn {
            background: #2ecc71; color: white; border: none; padding: 15px 30px;
            border-radius: 50px; font-size: 1.2rem; font-weight: bold;
            margin-bottom: 20px; box-shadow: 0 4px 0 #27ae60;
        }
        
        .pm-close-btn {
            position: absolute; top: 40px; right: 30px;
            background: transparent; color: #b2bec3; border: none;
            font-size: 1.2rem; font-weight: bold;
        }

        /* CUSTOM KEYBOARD CONTAINER - FIXED POSITION */
        .kb-container {
            position: relative; /* Not absolute anymore */
            margin-top: 15px; /* Sits right under the Add button */
            width: 100%; max-width: 900px;
            background: #2d3436;
            padding: 20px 5px;
            border-radius: 20px; /* Fully rounded */
            display: flex; flex-direction: column; gap: 8px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }
        
        .kb-row { display: flex; justify-content: center; gap: 6px; width: 100%; }
        .kb-key {
            background: #636e72; color: white;
            border: none; border-radius: 8px;
            font-size: 1.5rem; font-weight: bold;
            height: 55px; min-width: 40px; flex-grow: 1; max-width: 70px;
            box-shadow: 0 2px 0 rgba(0,0,0,0.3);
        }
        .kb-key:active { background: #dfe6e9; color: #2d3436; transform: translateY(2px); box-shadow: none; }
        .kb-key-wide { flex-grow: 2; max-width: 100px; background: #b2bec3; color: #2d3436; }
        .kb-key-space { flex-grow: 5; max-width: 400px; }
        .kb-key-done { background: #0984e3; color: white; flex-grow: 2; max-width: 120px; }

        .flying-score { position: fixed; font-size: 5rem; font-weight: 900; color: var(--text-color); z-index: 9999; pointer-events: none; transition: all 0.5s ease-in-out; text-shadow: 0px 0px 4px rgba(255,255,255,0.8); }
    </style>
</head>
<body>

<header class="app-header">
    <div class="header-content" id="headerContent">
        </div>
</header>

<div class="scroll-container" id="scrollContainer">
    <div id="roundsList"></div>
    <div class="controls-container" id="controlsContainer">
        <button onclick="resetGame(true)" class="main-btn btn-reset">‚Ü∫ NEW GAME</button>
        <button onclick="addRow()" class="main-btn btn-add">+ NEXT ROUND</button>
    </div>
</div>

<footer onclick="showStats()">
    <div class="footer-content" id="footerContent">
        </div>
</footer>

<div id="scoringOverlay">
    <div class="overlay-header">
        <div class="header-left">
            <div class="calc-title">SCORING FOR</div>
            <div class="player-name-display" id="playerNameDisplay">PLAYER</div>
        </div>
        <div class="tally-box">
            <div class="tally-info">
                <div class="tally-label" id="cardCountLabel">Cards: 0/7</div>
                <div class="tally-label" id="flipBonusLabel">Bonus: 0</div>
            </div>
            <div class="tally-total" id="currentTally">0</div>
        </div>
    </div>
    
    <div class="overlay-body">
        <div class="grid-modifiers">
            <div class="card modifier" onclick="toggleCard(this, 2)">+2</div>
            <div class="card modifier" onclick="toggleCard(this, 4)">+4</div>
            <div class="card modifier" onclick="toggleCard(this, 6)">+6</div>
            <div class="card modifier" onclick="toggleCard(this, 8)">+8</div>
            <div class="card modifier" onclick="toggleCard(this, 10)">+10</div>
            <div class="card multiplier" onclick="toggleCard(this, 'x2')">x2</div>
        </div>
        <div class="grid-numbers">
            <div class="card num" onclick="toggleCard(this, 0)">0</div>
            <div class="card num" onclick="toggleCard(this, 1)">1</div>
            <div class="card num" onclick="toggleCard(this, 2)">2</div>
            <div class="card num" onclick="toggleCard(this, 3)">3</div>
            <div class="card num" onclick="toggleCard(this, 4)">4</div>
            <div class="card num" onclick="toggleCard(this, 5)">5</div>
            <div class="card num" onclick="toggleCard(this, 6)">6</div>
            <div class="card num" onclick="toggleCard(this, 7)">7</div>
            <div class="card num" onclick="toggleCard(this, 8)">8</div>
            <div class="card num" onclick="toggleCard(this, 9)">9</div>
            <div class="card num" onclick="toggleCard(this, 10)">10</div>
            <div class="card num" onclick="toggleCard(this, 11)">11</div>
            <div class="card num" onclick="toggleCard(this, 12)">12</div>
        </div>
    </div>
    <div class="action-bar">
        <button class="action-btn btn-bust" onclick="triggerBust()">BUST</button>
        <button class="action-btn btn-manual" onclick="showManual()">MANUAL</button>
        <button class="action-btn btn-cancel" onclick="closeOverlay()">CANCEL</button>
        <button class="action-btn btn-ok" onclick="applyCurrentTally(true)">OK</button>
    </div>
</div>

<div id="manualModal">
    <div id="manualDisplay">0</div>
    <div class="numpad">
        <button class="num-btn" onclick="pressNum(1)">1</button>
        <button class="num-btn" onclick="pressNum(2)">2</button>
        <button class="num-btn" onclick="pressNum(3)">3</button>
        <button class="num-btn" onclick="pressNum(4)">4</button>
        <button class="num-btn" onclick="pressNum(5)">5</button>
        <button class="num-btn" onclick="pressNum(6)">6</button>
        <button class="num-btn" onclick="pressNum(7)">7</button>
        <button class="num-btn" onclick="pressNum(8)">8</button>
        <button class="num-btn" onclick="pressNum(9)">9</button>
        <button class="num-btn btn-clear" style="background:#d63031" onclick="pressNum('C')">C</button>
        <button class="num-btn" onclick="pressNum(0)">0</button>
        <div></div>
    </div>
    <div class="manual-actions-row">
        <button class="btn-manual-ok" onclick="pressNum('OK')">OK</button>
        <button class="manual-cancel-btn" onclick="closeManual()">CANCEL</button>
    </div>
</div>

<div id="victoryOverlay">
    <div class="victory-title">WINNER!</div>
    
    <div class="hulu-container">
        <svg width="180" height="240" viewBox="0 0 100 140" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <linearGradient id="gourdGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:#f1c40f;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#e67e22;stop-opacity:1" />
                </linearGradient>
            </defs>
            <ellipse cx="50" cy="40" rx="25" ry="30" fill="url(#gourdGrad)" />
            <ellipse cx="50" cy="95" rx="40" ry="45" fill="url(#gourdGrad)" />
            <path d="M50 10 Q40 0 55 -5" stroke="#27ae60" stroke-width="6" fill="none" />
            <path d="M35 68 Q50 75 65 68" stroke="#c0392b" stroke-width="4" fill="none" />
        </svg>
    </div>

    <div class="winner-name" id="winnerName">PLAYER</div>
    
    <div class="final-scores" id="finalScoresList"></div>

    <div class="victory-actions">
        <button class="v-btn v-btn-close" onclick="closeVictory()">CLOSE</button>
        <button class="v-btn v-btn-new" onclick="startNewGameFromVictory()">NEW GAME</button>
    </div>
</div>

<div id="statsOverlay" onclick="closeStats()">
    <div class="stats-container">
        <div class="stats-title">GAME STATS</div>
        <div id="statsContent"></div>
    </div>
</div>

<div id="playerManagerOverlay">
    <div class="pm-title">MANAGE PLAYERS</div>
    <button class="pm-close-btn" onclick="closePlayerManager()">CLOSE</button>
    
    <div class="pm-list-container" id="playerListContainer">
        </div>
    
    <button class="pm-add-btn" onclick="addNewPlayer()">+ ADD PLAYER</button>
    
    <div class="kb-container" id="customKeyboard" style="display:none;">
        <div class="kb-row">
            <button class="kb-key" onclick="kbType('Q')">Q</button>
            <button class="kb-key" onclick="kbType('W')">W</button>
            <button class="kb-key" onclick="kbType('E')">E</button>
            <button class="kb-key" onclick="kbType('R')">R</button>
            <button class="kb-key" onclick="kbType('T')">T</button>
            <button class="kb-key" onclick="kbType('Y')">Y</button>
            <button class="kb-key" onclick="kbType('U')">U</button>
            <button class="kb-key" onclick="kbType('I')">I</button>
            <button class="kb-key" onclick="kbType('O')">O</button>
            <button class="kb-key" onclick="kbType('P')">P</button>
        </div>
        <div class="kb-row">
            <button class="kb-key" onclick="kbType('A')">A</button>
            <button class="kb-key" onclick="kbType('S')">S</button>
            <button class="kb-key" onclick="kbType('D')">D</button>
            <button class="kb-key" onclick="kbType('F')">F</button>
            <button class="kb-key" onclick="kbType('G')">G</button>
            <button class="kb-key" onclick="kbType('H')">H</button>
            <button class="kb-key" onclick="kbType('J')">J</button>
            <button class="kb-key" onclick="kbType('K')">K</button>
            <button class="kb-key" onclick="kbType('L')">L</button>
        </div>
        <div class="kb-row">
            <button class="kb-key kb-key-wide" onclick="kbType('CAPS')">‚áß</button>
            <button class="kb-key" onclick="kbType('Z')">Z</button>
            <button class="kb-key" onclick="kbType('X')">X</button>
            <button class="kb-key" onclick="kbType('C')">C</button>
            <button class="kb-key" onclick="kbType('V')">V</button>
            <button class="kb-key" onclick="kbType('B')">B</button>
            <button class="kb-key" onclick="kbType('N')">N</button>
            <button class="kb-key" onclick="kbType('M')">M</button>
            <button class="kb-key kb-key-wide" onclick="kbType('BACK')">‚å´</button>
        </div>
        <div class="kb-row">
            <button class="kb-key kb-key-space" onclick="kbType(' ')">SPACE</button>
            <button class="kb-key kb-key-done" onclick="stopEditing()">DONE</button>
        </div>
    </div>
</div>

<script>
    (function generateAppIcon() {
        const canvas = document.createElement('canvas'); canvas.width = 180; canvas.height = 180; const ctx = canvas.getContext('2d');
        ctx.fillStyle = "#0984e3"; ctx.fillRect(0, 0, 180, 180);
        ctx.fillStyle = "white"; ctx.font = "bold 100px sans-serif"; ctx.textAlign = "center"; ctx.textBaseline = "middle"; ctx.fillText("7", 90, 95);
        const dataURL = canvas.toDataURL('image/png');
        let link = document.createElement('link'); link.rel = 'apple-touch-icon'; link.href = dataURL; document.head.appendChild(link);
    })();

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playClick() { if(audioCtx.state === 'suspended') audioCtx.resume(); const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = 'triangle'; osc.frequency.setValueAtTime(800, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.05); gain.gain.setValueAtTime(0.2, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.05); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.05); }
    function playPop() { if(audioCtx.state === 'suspended') audioCtx.resume(); const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = 'sine'; osc.frequency.setValueAtTime(400, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(600, audioCtx.currentTime + 0.1); gain.gain.setValueAtTime(0.3, audioCtx.currentTime); gain.gain.linearRampToValueAtTime(0.01, audioCtx.currentTime + 0.1); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.1); }
    function playScoreSound() { if(audioCtx.state === 'suspended') audioCtx.resume(); const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = 'sine'; osc.frequency.setValueAtTime(200, audioCtx.currentTime); gain.gain.setValueAtTime(0.5, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.3); }
    function playVictorySound() { if(audioCtx.state === 'suspended') audioCtx.resume(); const now = audioCtx.currentTime; [440, 554, 659, 880].forEach((freq, i) => { const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = 'triangle'; osc.frequency.value = freq; gain.gain.setValueAtTime(0.2, now + i*0.1); gain.gain.exponentialRampToValueAtTime(0.01, now + i*0.1 + 0.5); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(now + i*0.1); osc.stop(now + i*0.1 + 0.5); }); }

    // --- GAME STATE ---
    let activeCell = null;
    let activeRowId = 0; 
    let selectedCards = { nums: new Set(), mods: new Set(), x2: false };
    let manualValue = "";
    
    // PLAYER DATA
    let players = ["Áà∏", "Â™Ω", "Ë™†", "Â®ú"];
    let editingPlayerIndex = -1;

    // Load from storage if available
    window.addEventListener('load', () => { 
        const savedPlayers = localStorage.getItem('flip7_players');
        if (savedPlayers) { players = JSON.parse(savedPlayers); }
        initGrid();
        loadGame(); 
    });

    function savePlayers() {
        localStorage.setItem('flip7_players', JSON.stringify(players));
    }

    // Initialize Grid CSS based on player count
    function initGrid() {
        const cols = '50px ' + Array(players.length).fill('1fr').join(' ');
        document.documentElement.style.setProperty('--grid-cols', cols);
        renderHeader();
        renderFooter();
    }

    function renderHeader() {
        const content = document.getElementById('headerContent');
        let html = `<div></div>`; // Spacer
        players.forEach((p, index) => {
            html += `<div class="header-name" onclick="openPlayerManager()">${p}</div>`;
        });
        content.innerHTML = html;
    }

    function renderFooter() {
        const content = document.querySelector('.footer-content');
        let html = `<div class="sigma-icon">Œ£</div>`;
        players.forEach((p, i) => {
            html += `<div class="total-box" id="box-${i}"><span class="crown">üëë</span><span class="total-val" id="total-${i}">0</span></div>`;
        });
        content.innerHTML = html;
    }

    // --- PLAYER MANAGER ---
    function openPlayerManager() {
        playClick();
        renderPlayerList();
        document.getElementById('playerManagerOverlay').style.display = 'flex';
    }

    function closePlayerManager() {
        playClick();
        stopEditing();
        document.getElementById('playerManagerOverlay').style.display = 'none';
        initGrid(); // Refresh layout
        reloadRowsForNewLayout(); 
        calculateTotals();
        savePlayers();
    }

    function renderPlayerList() {
        const container = document.getElementById('playerListContainer');
        container.innerHTML = '';
        players.forEach((p, i) => {
            const isActive = (i === editingPlayerIndex) ? 'active-edit' : '';
            container.innerHTML += `
                <div class="pm-player-row ${isActive}">
                    <div class="pm-name-display">${p}</div>
                    <div class="pm-row-actions">
                        <button class="pm-icon-btn" onclick="startEditing(${i})">‚úèÔ∏è</button>
                        <button class="pm-icon-btn" style="color:#ff7675" onclick="removePlayer(${i})">üóëÔ∏è</button>
                    </div>
                </div>
            `;
        });
    }

    function addNewPlayer() {
        playClick();
        players.push("Player");
        savePlayers();
        startEditing(players.length - 1);
    }

    function removePlayer(index) {
        if(confirm("Remove " + players[index] + "? This will delete their scores.")) {
            players.splice(index, 1);
            if(players.length === 0) players = ["Player"]; // Min 1
            savePlayers();
            if(editingPlayerIndex === index) stopEditing();
            renderPlayerList();
        }
    }

    // --- CUSTOM KEYBOARD LOGIC ---
    function startEditing(index) {
        editingPlayerIndex = index;
        document.getElementById('customKeyboard').style.display = 'flex';
        renderPlayerList();
    }

    function stopEditing() {
        editingPlayerIndex = -1;
        document.getElementById('customKeyboard').style.display = 'none';
        renderPlayerList();
        savePlayers();
    }

    function kbType(char) {
        if(editingPlayerIndex === -1) return;
        playClick();
        
        let currentName = players[editingPlayerIndex];
        
        if (char === 'BACK') {
            players[editingPlayerIndex] = currentName.slice(0, -1);
        } else if (char === 'CAPS') {
            // Toggle logic simplified for demo, assuming caps always for now
        } else if (char === 'DONE') { 
            stopEditing();
            return;
        } else {
            if(currentName.length < 8) { // Limit length
                players[editingPlayerIndex] += char;
            }
        }
        renderPlayerList();
    }

    // --- REBUILD ROWS ON STRUCTURE CHANGE ---
    function reloadRowsForNewLayout() {
        const rows = document.querySelectorAll('.round-row');
        
        // Save current visible data map
        let currentData = [];
        rows.forEach(row => {
            let rowData = [];
            let inputs = row.querySelectorAll('.score-display');
            inputs.forEach(input => rowData.push(input.innerText));
            currentData.push(rowData);
        });

        document.getElementById('roundsList').innerHTML = '';
        
        // Rebuild
        currentData.forEach((rowData, rIdx) => {
            const row = document.createElement('div');
            row.className = 'round-row';
            let html = `<div class="round-num">${rIdx + 1}</div>`;
            
            // Re-map old data to new columns. 
            for(let i=0; i < players.length; i++) {
                let val = (i < rowData.length) ? rowData[i] : "";
                html += `<div class="score-cell"><div id="r${rIdx+1}-p${i}" class="score-display p${i}-val" onclick="openScoring(this, ${i})">${val}</div></div>`;
            }
            row.innerHTML = html;
            document.getElementById('roundsList').appendChild(row);
        });
    }

    // --- GAME LOGIC ---
    function saveGame() {
        const rows = document.querySelectorAll('.round-row');
        const state = { activeRowId: activeRowId, rounds: [] };
        rows.forEach(row => {
            const roundId = row.querySelector('.round-num').innerText;
            const scores = [];
            for(let i=0; i<players.length; i++) {
                const cell = document.getElementById(`r${roundId}-p${i}`);
                scores.push(cell ? cell.innerText : "");
            }
            state.rounds.push({ id: roundId, scores: scores });
        });
        localStorage.setItem('flip7_save', JSON.stringify(state));
    }

    function loadGame() {
        const saved = localStorage.getItem('flip7_save');
        if (saved) {
            const state = JSON.parse(saved);
            document.getElementById('roundsList').innerHTML = '';
            activeRowId = 0;
            if (state.rounds && state.rounds.length > 0) {
                state.rounds.forEach(roundData => {
                    activeRowId = parseInt(roundData.id) - 1; 
                    addRow(false);
                    roundData.scores.forEach((score, i) => {
                        if(i < players.length && score !== "") {
                            const cell = document.getElementById(`r${roundData.id}-p${i}`);
                            if(cell) { cell.innerText = score; cell.style.color = "var(--text-color)"; }
                        }
                    });
                });
                calculateTotals();
            } else { addRow(); }
        } else { addRow(); }
    }

    function addRow(shouldScroll = true) {
        activeRowId++;
        const roundsList = document.getElementById('roundsList');
        const row = document.createElement('div');
        row.className = 'round-row';
        let html = `<div class="round-num">${activeRowId}</div>`;
        for(let i=0; i<players.length; i++) {
            html += `<div class="score-cell"><div id="r${activeRowId}-p${i}" class="score-display p${i}-val" onclick="openScoring(this, ${i})"></div></div>`;
        }
        row.innerHTML = html;
        roundsList.appendChild(row);
        if (shouldScroll) {
            playClick(); saveGame();
            const controls = document.getElementById('controlsContainer');
            setTimeout(() => { controls.scrollIntoView({ behavior: 'smooth', block: 'center' }); }, 100);
        }
    }

    function resetGame(confirmReq) {
        if(!confirmReq || confirm("Start a new game? This will clear all scores.")) {
            playClick(); localStorage.removeItem('flip7_save');
            document.getElementById('roundsList').innerHTML = '';
            activeRowId = 0;
            renderFooter(); // Clear totals visually
            addRow(); calculateTotals(); closeVictory();
        }
    }

    function openScoring(el, playerIndex) {
        playClick(); activeCell = el;
        document.getElementById('playerNameDisplay').innerText = players[playerIndex];
        selectedCards = { nums: new Set(), mods: new Set(), x2: false };
        document.querySelectorAll('.card').forEach(c => c.classList.remove('selected'));
        updateTally();
        const overlay = document.getElementById('scoringOverlay');
        overlay.style.display = 'flex'; void overlay.offsetWidth; overlay.style.opacity = '1';
    }

    function toggleCard(el, val) {
        playPop(); el.classList.toggle('selected');
        const isSelected = el.classList.contains('selected');
        if (val === 'x2') selectedCards.x2 = isSelected;
        else if (el.classList.contains('num')) isSelected ? selectedCards.nums.add(val) : selectedCards.nums.delete(val);
        else isSelected ? selectedCards.mods.add(val) : selectedCards.mods.delete(val);
        updateTally();
    }

    function updateTally() {
        let score = 0;
        selectedCards.nums.forEach(n => score += n);
        if (selectedCards.x2) score *= 2;
        selectedCards.mods.forEach(m => score += m);
        let bonus = (selectedCards.nums.size === 7) ? 15 : 0;
        score += bonus;
        document.getElementById('currentTally').innerText = score;
        document.getElementById('flipBonusLabel').innerText = `Bonus: ${bonus > 0 ? '+15' : '0'}`;
        document.getElementById('cardCountLabel').innerText = `Cards: ${selectedCards.nums.size}/7`;
        document.getElementById('cardCountLabel').style.color = (selectedCards.nums.size === 7) ? "#27ae60" : "#636e72";
    }

    function applyCurrentTally(animate) { playClick(); applyScore(document.getElementById('currentTally').innerText, animate, 'currentTally'); }
    function triggerBust() { playClick(); document.getElementById('currentTally').innerText = "0"; applyScore(0, true, 'currentTally'); }

    function applyScore(val, animate, sourceId) {
        if (!activeCell) return;
        if (animate && sourceId) animateScoreTransfer(val, sourceId);
        else { finalizeScore(val); closeOverlay(); closeManual(); }
    }

    function animateScoreTransfer(val, sourceId) {
        const sourceEl = document.getElementById(sourceId);
        const targetEl = activeCell;
        const containerId = (sourceId === 'currentTally') ? 'scoringOverlay' : 'manualModal';
        const container = document.getElementById(containerId);
        const sourceRect = sourceEl.getBoundingClientRect();
        const targetRect = targetEl.getBoundingClientRect();
        const flyer = document.createElement('div');
        flyer.classList.add('flying-score');
        flyer.innerText = val;
        flyer.style.top = `${sourceRect.top}px`; flyer.style.left = `${sourceRect.left}px`; flyer.style.width = `${sourceRect.width}px`; flyer.style.height = `${sourceRect.height}px`; flyer.style.textAlign = (sourceId === 'currentTally') ? 'right' : 'center';
        document.body.appendChild(flyer);
        flyer.getBoundingClientRect(); 
        if (containerId === 'manualModal') { document.getElementById('manualModal').style.display = 'none'; document.getElementById('scoringOverlay').style.opacity = '0'; } 
        else { container.style.opacity = '0'; }
        flyer.style.top = `${targetRect.top + (targetRect.height/2 - 20)}px`; flyer.style.left = `${targetRect.left}px`; flyer.style.width = `${targetRect.width}px`; flyer.style.textAlign = 'center'; flyer.style.fontSize = '2.8rem'; 
        setTimeout(() => {
            finalizeScore(val); flyer.remove();
            document.getElementById('scoringOverlay').style.display = 'none'; document.getElementById('scoringOverlay').style.opacity = '1';
        }, 500);
    }

    function finalizeScore(val) {
        playScoreSound();
        activeCell.innerText = val; activeCell.style.color = "var(--text-color)";
        activeCell.style.transform = "scale(1.2)"; setTimeout(() => activeCell.style.transform = "scale(1)", 200);
        calculateTotals(); saveGame(); checkWinCondition();
    }

    function closeOverlay() { playClick(); document.getElementById('scoringOverlay').style.display = 'none'; }

    function calculateTotals() {
        let sums = new Array(players.length).fill(0);
        for (let i = 0; i < players.length; i++) {
            document.querySelectorAll(`.p${i}-val`).forEach(el => sums[i] += parseInt(el.innerText) || 0);
            if(document.getElementById(`total-${i}`))
                document.getElementById(`total-${i}`).innerText = sums[i];
        }
        const max = Math.max(...sums);
        for (let i = 0; i < players.length; i++) {
            const box = document.getElementById(`box-${i}`);
            if(box) (sums[i] === max && max > 0) ? box.classList.add('is-leading') : box.classList.remove('is-leading');
        }
        return sums;
    }

    function checkWinCondition() {
        let roundComplete = true;
        for(let i=0; i<players.length; i++) {
            let cell = document.getElementById(`r${activeRowId}-p${i}`);
            if(!cell || cell.innerText === "") { roundComplete = false; break; }
        }
        if(!roundComplete) return;

        let totals = calculateTotals();
        let max = Math.max(...totals);
        let winners = [];
        for(let i=0; i<players.length; i++) { if(totals[i] === max) winners.push(i); }

        if(winners.length === 1 && max >= 200) {
            playVictorySound();
            showVictory(winners[0], totals);
        } else {
            setTimeout(() => addRow(), 800); 
        }
    }

    function showVictory(winnerIndex, totals) {
        const overlay = document.getElementById('victoryOverlay');
        document.getElementById('winnerName').innerText = players[winnerIndex];
        const scoresList = document.getElementById('finalScoresList');
        scoresList.innerHTML = '';
        for(let i=0; i<players.length; i++) {
            let div = document.createElement('div');
            div.className = 'final-score-box';
            div.innerHTML = `<div class="fs-label">${players[i]}</div><div class="fs-val">${totals[i]}</div>`;
            scoresList.appendChild(div);
        }
        overlay.style.display = 'flex';
    }

    function closeVictory() { playClick(); document.getElementById('victoryOverlay').style.display = 'none'; }
    function startNewGameFromVictory() { resetGame(false); }

    function showStats() {
        playClick();
        const totals = calculateTotals();
        const max = Math.max(...totals);
        const content = document.getElementById('statsContent');
        content.innerHTML = '';

        for(let i=0; i<players.length; i++) {
            const diff200 = 200 - totals[i];
            const diffLeader = max - totals[i];
            const isLeader = (diffLeader === 0);
            
            let pct = Math.min((totals[i] / 200) * 100, 100);
            
            let behindHTML = isLeader 
                ? `<div class="stat-metric" style="justify-content: center;">
                     <span class="stat-metric-val val-gold">Leader</span>
                   </div>` 
                : `<div class="stat-metric">
                     <div class="stat-metric-label">Behind</div>
                     <span class="stat-metric-val val-bad">-${diffLeader}</span>
                   </div>`;

            let to200Text = diff200 <= 0 ? 'Done' : `${diff200} left`;

            let row = document.createElement('div');
            row.className = 'stat-row';
            row.innerHTML = `
                <div class="stat-name">${players[i]}</div>
                <div class="progress-track">
                    <div class="progress-bar" style="width: ${pct}%;"></div>
                    <span class="pb-text-left">${totals[i]}</span>
                    <span class="pb-text-right">${to200Text}</span>
                </div>
                ${behindHTML}
            `;
            content.appendChild(row);
        }
        document.getElementById('statsOverlay').style.display = 'flex';
    }

    function closeStats() { playClick(); document.getElementById('statsOverlay').style.display = 'none'; }
    function showManual() { playClick(); manualValue = ""; document.getElementById('manualDisplay').innerText = "0"; document.getElementById('manualModal').style.display = 'block'; }
    function closeManual() { playClick(); document.getElementById('manualModal').style.display = 'none'; }
    function pressNum(v) {
        playClick();
        if (v === 'C') manualValue = "";
        else if (v === 'OK') { applyScore(manualValue || 0, true, 'manualDisplay'); return; }
        else if (manualValue.length < 4) manualValue += v;
        document.getElementById('manualDisplay').innerText = manualValue || "0";
    }
</script>
</body>
</html>
